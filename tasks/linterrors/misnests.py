import regex

regexes = {
    # Two-tag misnests
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\7>))).)*)<\/\1>( *)<\/\4>": r"<\1\2>\3<\4\5>\6</\4>\8</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<\/\1>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)| *).)+)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\5>|<\1(?:[^>]*)?>)|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\8>)).)*)<\/\1>((?:(?!(?:<\5>|<\/\5>)).)+)<\/\5>": r"<\1\2>\3</\1><\5\6><\1\2>\7</\1>\9</\5>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\7>))).)*)<\/\1>((?:(?!<\/\1>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\9>)| *).)+)<\/\4>": r"<\4\5>\3<\1\2>\6</\1>\8</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<\/\1>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)| *).)+)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\5>": r"<\1\2>\3<\5\6>\7</\5></\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<\/\1>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)| *).)+)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\5>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\8>))).)*)<\/\1>((?:(?!(?:<\5>|<\/\5>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)+)<\/\5>": r"<\1\2>\3</\1><\5\6><\1\2>\7</\1>\9</\5>",
    #r"'''((?:(?!''').)*)(?<!')''(?!')((?:(?!(?:(?<!')''(?!')|'''''|''')).)*)'''((?:(?!''').)*)(?<!')''(?!')": r"'''\1''' '''''\2'''\3''"

    # Three-tag misnests
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>( *)<\/\1>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\11</\4>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\1>( *)<\/\7>( *)<\/\4>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\11</\4>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\/\7>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\4>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>( *)<\/\7>( *)<\/\1>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\11</\4>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\7>( *)<\/\1>( *)<\/\4>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\11</\4>\12</\1>",
    # \11
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>( *)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\13>)).)+)<\/\7>": r"<\7\8>\3<\1\2>\6<\4\5>\9</\4>\11</\1>\12</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\1>( *)<\/\7>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\13>)).)+)<\/\4>": r"<\4\5>\3<\7\8>\6<\1\2>\9</\1>\11</\7>\12</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\1>( *)<\/\4>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\13>)).)+)<\/\7>": r"<\7\8>\3<\4\5>\6<\1\2>\9</\1>\11</\4>\12</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>( *)<\/\7>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\13>)).)+)<\/\1>": r"<\1\2>\3<\7\8>\6<\4\5>\9</\4>\11</\7>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\7>( *)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\13>)).)+)<\/\4>": r"<\4\5>\3<\1\2>\6<\7\8>\9</\7>\11</\1>\12</\4>",
    # \10
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\1>( *)<\/\7>": r"<\7\8>\3<\1\2>\6<\4\5>\9</\4>\11</\1>\12</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\7>( *)<\/\4>": r"<\4\5>\3<\7\8>\6<\1\2>\9</\1>\11</\7>\12</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\4>( *)<\/\7>": r"<\7\8>\3<\4\5>\6<\1\2>\9</\1>\11</\4>\12</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\7>( *)<\/\1>": r"<\1\2>\3<\7\8>\6<\4\5>\9</\4>\11</\7>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\7>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\1>( *)<\/\4>": r"<\4\5>\3<\1\2>\6<\7\8>\9</\7>\11</\1>\12</\4>",
    # \6
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\7>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\4>( *)<\/\1>( *)<\/\8>": r"<\1\2>\3<\4\5>\6<\8\9>\10</\8>\11</\4>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\7>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\1>( *)<\/\8>( *)<\/\4>": r"<\1\2>\3<\4\5>\6<\8\9>\10</\8>\11</\4>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\7>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\1>( *)<\/\4>( *)<\/\8>": r"<\1\2>\3<\4\5>\6<\8\9>\10</\8>\11</\4>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\7>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\4>( *)<\/\8>( *)<\/\1>": r"<\1\2>\3<\4\5>\6<\8\9>\10</\8>\11</\4>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\7>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\8>( *)<\/\1>( *)<\/\4>": r"<\1\2>\3<\4\5>\6<\8\9>\10</\8>\11</\4>\12</\1>",
    # \3
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\5>( *)<\/\1>( *)<\/\8>": r"<\1\2>\3<\5\6>\7<\8\9>\10</\8>\11</\5>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\1>( *)<\/\8>( *)<\/\5>": r"<\1\2>\3<\5\6>\7<\8\9>\10</\8>\11</\5>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\1>( *)<\/\5>( *)<\/\8>": r"<\1\2>\3<\5\6>\7<\8\9>\10</\8>\11</\5>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\5>( *)<\/\8>( *)<\/\1>": r"<\1\2>\3<\5\6>\7<\8\9>\10</\8>\11</\5>\12</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\4>)).)+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\11>))).)*)<\/\8>( *)<\/\1>( *)<\/\5>": r"<\1\2>\3<\5\6>\7<\8\9>\10</\8>\11</\5>\12</\1>",
    # \10 + \11
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\14>)).)+)<\/\7>": r"<\7\8>\3<\1\2>\6<\4\5>\9</\4>\11</\1>\13</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\7>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\14>)).)+)<\/\4>": r"<\4\5>\3<\7\8>\6<\1\2>\9</\1>\11</\7>\13</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\4>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\14>)).)+)<\/\7>": r"<\7\8>\3<\4\5>\6<\1\2>\9</\1>\11</\4>\13</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\4>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\7>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\14>)).)+)<\/\1>": r"<\1\2>\3<\7\8>\6<\4\5>\9</\4>\11</\7>\13</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>\/]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>|<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\10>))).)*)<\/\7>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\12>)).)+)<\/\1>((?:(?!<(?!(?:nowiki|syntaxhighlight))([^ >]*)(?: [^>\/]*)?>[^<]*(?!<\/\14>)).)+)<\/\4>": r"<\4\5>\3<\1\2>\6<\7\8>\9</\7>\11</\1>\13</\4>"
}


def fix_misnests(page: str, text: str) -> str:
    lines = text.split("\n")
    fixes = []
    for i, line in enumerate(lines):
        new_line = line
        _ = new_line
        while True:
            for find, replace in regexes.items():
                if not regex.search(r"<(?:nowiki|syntaxhighlight)>.*"+find+r".*<\/(?:nowiki|syntaxhighlight)>", line):
                    _ = regex.sub(find, replace, _)
            if _ != new_line:
                new_line = _
            else:
                break
        if new_line != line:
            fixes.append((i, new_line))
    i = 0
    while i < len(fixes):
        if regex.search(r"\{\{.*\}\}", fixes[i][1]) and not regex.search(r"(?:\{\{(?:(?!(?:'''?|<\/?[^ >]*>)).)*\}\})", fixes[i][1]):
            print("(Filtering) Illegal combination in template invocation")
        elif regex.search(r"(?:<(?!(?:nowiki|syntaxhighlight))([^/][^ >]*)(?: [^>]*)?>.*\[\[(?:(?!<\1>).)*<\/\1>.*\]\]|\[\[.*<(?!(?:nowiki|syntaxhighlight))([^/][^ >]*)(?: [^>]*)?>(?:(?!<\/\2>).)*\]\].*<\/\2>)", fixes[i][1]):
            print("(Filtering) Illegal combination in wikilink")
        elif regex.search(r"<\/center><\/font>''", fixes[i][1]):
            print("(Filtering) Unhandleable italics+tags signature")
        elif regex.search(r"(?:<[^\/>]+>[^<>]*?){4,5}.*?(?:<\/[^\/>]+>[^<>]*?){4,5}", fixes[i][1]):
            print("(Filtering) Consecutive 4-5 tags")
        else:
            i += 1
            continue
        fixes.pop(i)
        i = 0
    for fix in fixes:
        lines[fix[0]] = fix[1]
    text = "\n".join(lines)
    return text
