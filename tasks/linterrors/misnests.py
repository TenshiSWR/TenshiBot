import regex

regexes = {
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?> *(?<!')''(?!')(.*)<\/\1>(?<!')''(?!')": r"''<\1\2>\3</\1>''",
    r"(?<!')''(?!') *<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!<\/\1>).)*)(?<!')''(?!')(.*)<\/\1>": r"<\1\2>''\3''\4</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\4>": r"<\1\2>\3<\4\5>\6</\4>\7</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>((?:(?!<\/\1>).)+)<\/\4>": r"<\1\2>\3<\4\5>\6</\4></\1><\4\5>\7</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!<\/\1>).)+)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\4>": r"<\1\2>\3<\4\5>\6</\4></\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!<\/\1>).)+)<(?!(?:nowiki|syntaxhighlight|\1))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>((?:(?!(?:<\4>|<\/\4>)).)+)<\/\4>": r"<\1\2>\3</\1><\4\5><\1\2>\6</\1>\7</\4>",
    #r"'''((?:(?!''').)*)(?<!')''(?!')((?:(?!(?:(?<!')''(?!')|'''''|''')).)*)'''((?:(?!''').)*)(?<!')''(?!')": r"'''\1''' '''''\2'''\3''"
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\4>( *)<\/\1>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\7>( *)<\/\4>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\4>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    # \11
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\4>( *)<\/\1>(.+)<\/\7>": r"<\7\8>\3<\1\2>\6<\4\5>\9</\4>\10</\1>\11</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\7>(.+)<\/\4>": r"<\4\5>\3<\7\8>\6<\1\2>\9</\1>\10</\7>\11</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\4>(.+)<\/\7>": r"<\7\8>\3<\4\5>\6<\1\2>\9</\1>\10</\4>\11</\7>",
    # \10
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\4>(.+)<\/\1>( *)<\/\7>": r"<\7\8>\3<\1\2>\6<\4\5>\9</\4>\10</\1>\11</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>(.+)<\/\7>( *)<\/\4>": r"<\4\5>\3<\7\8>\6<\1\2>\9</\1>\10</\7>\11</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>(.+)<\/\4>( *)<\/\7>": r"<\7\8>\3<\4\5>\6<\1\2>\9</\1>\10</\4>\11</\7>",
    # \6
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>(.+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\4>( *)<\/\1>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>(.+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\7>( *)<\/\4>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>(.+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\4>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    # \3
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>(.+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\4>( *)<\/\1>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>(.+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\7>( *)<\/\4>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>(.+)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>( *)<\/\4>( *)<\/\7>": r"<\1\2>\3<\4\5>\6<\7\8>\9</\7>\10</\4>\11</\1>",
    # \10 + \11
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\4>(.+)<\/\1>(.+)<\/\7>": r"<\7\8>\3<\1\2>\6<\4\5>\9</\4>\10</\1>\11</\7>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>(.+)<\/\7>(.+)<\/\4>": r"<\4\5>\3<\7\8>\6<\1\2>\9</\1>\10</\7>\11</\4>",
    r"<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>( *)<(?!(?:nowiki|syntaxhighlight))([^ >]*)( [^>]*)?>((?:(?!(?:<\/\4>|<\1(?:[^>]*)?>)).)*)<\/\1>(.+)<\/\4>(.+)<\/\7>": r"<\7\8>\3<\4\5>\6<\1\2>\9</\1>\10</\4>\11</\7>"
}


def fix_misnests(page: str, text: str) -> tuple:
    lines = text.split("\n")
    fixes = []
    for i, line in enumerate(lines):
        new_line = line
        for find, replace in regexes.items():
            if not regex.search(r"<(?:nowiki|syntaxhighlight)>.*"+find+r".*<\/(?:nowiki|syntaxhighlight)>", line):
                new_line = regex.sub(find, replace, new_line)
        if new_line != line:
            fixes.append((i, new_line))
    i = 0
    while i < len(fixes):
        if regex.search(r"\{\{(?:(?!(?:'''?|<\/?[^ >]*>)))\}\}", fixes[i][1]):
            print("(Filtering) Illegal combination in template invocation")
        elif regex.search(r"(?:<(?!(?:nowiki|syntaxhighlight))([^/][^ >]*)(?: [^>]*)?>.*\[\[(?:(?!<\1>).)*<\/\1>.*\]\]|\[\[.*<(?!(?:nowiki|syntaxhighlight))([^/][^ >]*)(?: [^>]*)?>(?:(?!<\/\2>).)*\]\].*<\/\2>)", fixes[i][1]):
            print("(Filtering) Illegal combination in wikilink")
        else:
            i += 1
            continue
        fixes.pop(i)
        i = 0
    for fix in fixes:
        lines[fix[0]] = fix[1]
    text = "\n".join(lines)
    return text, "6"

